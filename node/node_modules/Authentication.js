
module.exports = function(query){
	pass = require('pwd');
	function authenticate(name, password, type, fn) {
		if (!module.parent) console.log('authenticating %s:%s', name, password);
		//look up prepared statements to sanetize statements. 
		query.validUser(name, type, function(error, rows, file){
		  var user = rows[0];
		  // query the db for the given username
		  if (!user) return fn(new Error('cannot find user'));
		  // apply the same algorithm to the POSTed password, applying
		  // the hash against the pass / salt, if there is a match we
		  // found the user
		  pass.hash(password, user.Salt, function(err, hash){
		    if (err) return fn(err);
		    if (JSON.stringify(hash) == user.Password) return fn(null, user);
		    fn(new Error('invalid password'));
		  });
		});
	}

	function restrictStaff(req, res, next) {
		if (req.session.user && (req.session.level == 1)) {
		  next();
		} 
		else if(!req.session.level){
		  res.redirect('/NoAcess.html');
		}
		else {
		  req.session.error = 'Access denied!';
		  res.redirect('/login.html');
		}
	}

	function restrictStudent(req, res, next) {
		if (req.session.user && (req.session.level == 0)) {
		  next();
		}
		else if(req.session.level){
		  res.redirect('/NoAcess.html');
		}
		else {
		  req.session.error = 'Access denied!';
		  res.redirect('/login.html');
		}
	}

	function loggedin(req, res, next){
		if (req.session.user){
		  res.redirect('/Student/home.html');
		}
		else{
		  next();
		}
	}

  return {authenticate: authenticate, restrictStaff: restrictStaff, restrictStudent: restrictStudent, loggedin:loggedin};

}